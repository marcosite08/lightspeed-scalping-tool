<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightspeed X-Series Scalping Tool - Construmas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .api-version {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .content {
            padding: 40px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .button {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .button.small {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .button.danger {
            background: #e74c3c;
        }
        
        .button.danger:hover {
            background: #c0392b;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .date-input, .select-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin: 10px;
            font-size: 16px;
        }
        
        .closure-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .closure-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .closure-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .closure-outlet {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .closure-id {
            font-family: monospace;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .closure-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            color: #495057;
        }
        
        .detail-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .detail-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .summary {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .api-info {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        .payments-breakdown {
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .payment-type {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }
        
        @media (max-width: 768px) {
            .closure-details {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Lightspeed X-Series Scalping Tool</h1>
            <p>Automatizaci√≥n de cierres para Construmas</p>
            <div class="api-version">X-Series API v2.0</div>
        </div>
        
        <div class="content">
            <div id="status" class="status">
                üîÑ Inicializando conexi√≥n X-Series...
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('closures')">üìã Cierres</button>
                <button class="tab" onclick="showTab('connection')">üîó Conexi√≥n</button>
                <button class="tab" onclick="showTab('explore')">üîç Explorar</button>
                <button class="tab" onclick="showTab('dates')">üìÖ Fechas</button>
                <button class="tab" onclick="showTab('help')">‚ùì Ayuda</button>
            </div>
            
            <!-- Tab: Cierres (Principal) -->
            <div id="tab-closures" class="tab-content active">
                <div class="controls">
                    <h3>üìã B√∫squeda de Cierres X-Series</h3>
                    <p>Busca y abre cierres autom√°ticamente usando la API X-Series</p>
                    <input type="date" id="dateInput" class="date-input" value="">
                    <button class="button" onclick="searchClosures()">
                        üìã Buscar Cierres
                    </button>
                    <button class="button danger" onclick="openAllClosures()">
                        üîì Abrir Todos los Cierres
                    </button>
                </div>
                
                <div class="api-info">
                    <strong>üéØ X-Series API:</strong> Usando endpoint /registers/:id/payments_summary para obtener datos exactos de cierres
                </div>
                
                <div id="closures-results"></div>
            </div>
            
            <!-- Tab: Conexi√≥n -->
            <div id="tab-connection" class="tab-content">
                <div class="controls">
                    <h3>üîó Prueba de Conexi√≥n X-Series</h3>
                    <p>Verifica la conectividad con la API de Lightspeed X-Series</p>
                    <button class="button" onclick="testConnection()">
                        üîç Probar Conexi√≥n
                    </button>
                </div>
                <div id="connection-results"></div>
            </div>
            
            <!-- Tab: Explorar -->
            <div id="tab-explore" class="tab-content">
                <div class="controls">
                    <h3>üîç Exploraci√≥n de X-Series</h3>
                    <p>Descubre los endpoints disponibles en tu API X-Series</p>
                    <button class="button" onclick="exploreAPI()">
                        üöÄ Explorar X-Series
                    </button>
                </div>
                <div id="explore-results"></div>
            </div>
            
            <!-- Tab: Fechas -->
            <div id="tab-dates" class="tab-content">
                <div class="controls">
                    <h3>üìÖ Fechas Disponibles</h3>
                    <p>Ve todas las fechas con cierres disponibles</p>
                    <button class="button" onclick="getAvailableDates()">
                        üìÖ Ver Fechas Disponibles
                    </button>
                </div>
                <div id="dates-results"></div>
            </div>
            
            <!-- Tab: Ayuda -->
            <div id="tab-help" class="tab-content">
                <div class="card">
                    <h3>üìö Documentaci√≥n X-Series</h3>
                    <p><strong>API Principal:</strong> <a href="https://x-series-api.lightspeedhq.com/" target="_blank">https://x-series-api.lightspeedhq.com/</a></p>
                    <p><strong>Register Closing:</strong> <a href="https://x-series-api.lightspeedhq.com/docs/registers_closing" target="_blank">Documentaci√≥n de Cierres</a></p>
                    <p><strong>Webhooks:</strong> <a href="https://x-series-api.lightspeedhq.com/docs/webhooks" target="_blank">Configurar Notificaciones</a></p>
                </div>
                
                <div class="card">
                    <h3>üõ†Ô∏è Endpoints Clave</h3>
                    <ul>
                        <li><code>/registers</code> - Lista de registros</li>
                        <li><code>/registers/:id/payments_summary</code> - Datos de cierre</li>
                        <li><code>/outlets</code> - Informaci√≥n de tiendas</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h3>‚ö° Funcionalidades</h3>
                    <ul>
                        <li>‚úÖ Buscar cierres por fecha espec√≠fica</li>
                        <li>‚úÖ Abrir autom√°ticamente URLs de cierres</li>
                        <li>‚úÖ Ver detalles completos de pagos</li>
                        <li>‚úÖ Explorar API en tiempo real</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentClosures = [];
        
        // Establecer fecha de hoy por defecto
        window.addEventListener('load', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            testConnection();
        });
        
        function showTab(tabName) {
            // Ocultar todas las tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab seleccionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        async function testConnection() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('connection-results');
            
            statusDiv.textContent = 'üîÑ Conectando con Lightspeed X-Series...';
            statusDiv.className = 'status';
            
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="loading">üîÑ Probando conexi√≥n X-Series...</div>';
            }
            
            try {
                const response = await fetch('/api/test');
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.textContent = '‚úÖ Conexi√≥n exitosa con Lightspeed X-Series API';
                    statusDiv.className = 'status success';
                    
                    if (resultsDiv) {
                        let html = '<div class="card"><h3>‚úÖ Conexi√≥n X-Series Exitosa</h3>';
                        html += `<p><strong>API Version:</strong> ${data.api_version}</p>`;
                        html += `<p><strong>API URL:</strong> ${data.api_url}</p>`;
                        html += '<h4>Resultados de Pruebas:</h4>';
                        
                        for (const [endpoint, result] of Object.entries(data.test_results)) {
                            const statusClass = result.success ? 'success' : 'error';
                            html += `<div class="api-info">
                                <strong>${endpoint}</strong>: ${result.success ? '‚úÖ OK' : '‚ùå Error'}
                                ${result.count ? ` (${result.count} items)` : ''}
                                ${result.error ? `<br><small>${result.error}</small>` : ''}
                            </div>`;
                        }
                        
                        html += '<h4>Documentaci√≥n:</h4>';
                        for (const [name, url] of Object.entries(data.documentation)) {
                            html += `<p><a href="${url}" target="_blank">${name}</a></p>`;
                        }
                        
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    }
                } else {
                    throw new Error(data.error || 'Error de conexi√≥n');
                }
            } catch (error) {
                statusDiv.textContent = '‚ùå Error de conexi√≥n con Lightspeed X-Series';
                statusDiv.className = 'status error';
                
                if (resultsDiv) {
                    resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                }
            }
        }
        
        async function searchClosures() {
            const date = document.getElementById('dateInput').value;
            const resultsDiv = document.getElementById('closures-results');
            
            if (!date) {
                alert('Por favor selecciona una fecha');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">üîç Buscando cierres X-Series...</div>';
            
            try {
                const response = await fetch(`/api/closures?date=${date}`);
                const data = await response.json();
                
                if (data.success) {
                    currentClosures = data.data;
                    displayClosures(currentClosures, data);
                } else {
                    throw new Error(data.error || 'Error obteniendo cierres');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function displayClosures(closures, apiData) {
            const resultsDiv = document.getElementById('closures-results');
            
            if (closures.length === 0) {
                let html = '<div class="status warning">‚ö†Ô∏è No se encontraron cierres para esta fecha</div>';
                
                if (apiData.debug_info && apiData.debug_info.available_dates) {
                    html += '<div class="card"><h3>üìÖ Fechas Disponibles:</h3><ul>';
                    apiData.debug_info.available_dates.forEach(date => {
                        html += `<li><button class="button small" onclick="loadDate('${date}')">${date}</button></li>`;
                    });
                    html += '</ul></div>';
                }
                
                resultsDiv.innerHTML = html;
                return;
            }
            
            const totalSales = closures.reduce((sum, c) => sum + (c.sales || 0), 0);
            const totalPayments = closures.reduce((sum, c) => sum + (c.payments || 0), 0);
            
            let html = `<div class="summary">
                <h3>üìä Resumen X-Series para ${apiData.date}</h3>
                <div class="grid">
                    <div>
                        <p><strong>Total cierres:</strong> ${closures.length}</p>
                        <p><strong>Total ventas:</strong> ${totalSales.toFixed(2)}</p>
                    </div>
                    <div>
                        <p><strong>Total pagos:</strong> ${totalPayments.toFixed(2)}</p>
                        <p><strong>API Version:</strong> ${apiData.api_version}</p>
                    </div>
                </div>
            </div>`;
            
            closures.forEach(closure => {
                html += `<div class="closure-card">
                    <div class="closure-header">
                        <div class="closure-outlet">${closure.outlet}</div>
                        <div class="closure-id">${closure.id.split('-').pop()}</div>
                    </div>
                    
                    <div class="closure-details">
                        <div class="detail-item">
                            <div class="detail-label">Registro</div>
                            <div class="detail-value">${closure.register_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ventas</div>
                            <div class="detail-value">${(closure.sales || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Pagos</div>
                            <div class="detail-value">${(closure.payments || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Secuencia</div>
                            <div class="detail-value">${closure.sequence_number || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cerrado</div>
                            <div class="detail-value">${closure.closed_at ? new Date(closure.closed_at).toLocaleString() : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Estado</div>
                            <div class="detail-value">${closure.is_open ? 'üü° Abierto' : 'üî¥ Cerrado'}</div>
                        </div>
                    </div>`;
                
                // Mostrar desglose de pagos si est√° disponible
                if (closure.payments_breakdown && closure.payments_breakdown.length > 0) {
                    html += '<div class="payments-breakdown"><strong>üí≥ Desglose de Pagos:</strong>';
                    closure.payments_breakdown.forEach(payment => {
                        html += `<div class="payment-type">
                            <span>${payment.payment_type_name}</span>
                            <span>${parseFloat(payment.total || 0).toFixed(2)}</span>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += `<div style="margin-top: 15px;">
                        <button class="button" onclick="openClosure('${closure.url}')">
                            üîó Abrir Cierre
                        </button>
                        ${closure.id ? `<button class="button small secondary" onclick="testSpecificRegister('${closure.id}')">
                            üîç Test Registro
                        </button>` : ''}
                    </div>
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        async function exploreAPI() {
            const resultsDiv = document.getElementById('explore-results');
            resultsDiv.innerHTML = '<div class="loading">üîç Explorando X-Series API...</div>';
            
            try {
                const response = await fetch('/api/explore');
                const data = await response.json();
                
                if (data.success) {
                    let html = '<div class="grid">';
                    
                    for (const [endpoint, result] of Object.entries(data.exploration)) {
                        const statusClass = result.success ? 'success' : 'error';
                        html += `<div class="card">
                            <h3>${endpoint}</h3>
                            <div class="api-info">
                                ${result.success ? '‚úÖ Disponible' : '‚ùå No disponible'}
                            </div>`;
                        
                        if (result.success) {
                            html += `<p><strong>Count:</strong> ${result.count}</p>`;
                            if (result.sample_keys && result.sample_keys.length > 0) {
                                html += `<p><strong>Keys:</strong> ${result.sample_keys.slice(0, 5).join(', ')}${result.sample_keys.length > 5 ? '...' : ''}</p>`;
                            }
                        } else {
                            html += `<p><strong>Error:</strong> ${result.error}</p>`;
                        }
                        
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    html += `<div class="card">
                        <h3>üìö Documentaci√≥n X-Series</h3>
                        <p><strong>API Version:</strong> ${data.api_version}</p>
                        <p><a href="${data.documentation}" target="_blank">Ver Documentaci√≥n Completa</a></p>
                    </div>`;
                    
                    resultsDiv.innerHTML = html;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error explorando API: ${error.message}</div>`;
            }
        }
        
        async function getAvailableDates() {
            const resultsDiv = document.getElementById('dates-results');
            resultsDiv.innerHTML = '<div class="loading">üìÖ Obteniendo fechas disponibles...</div>';
            
            try {
                const response = await fetch('/api/available-dates');
                const data = await response.json();
                
                if (data.success) {
                    let html = `<div class="card">
                        <h3>üìÖ Fechas con Cierres Disponibles</h3>
                        <p><strong>Total registros:</strong> ${data.total_registers}</p>
                        <p><strong>Fechas con cierres:</strong> ${data.dates_list.length}</p>
                    </div>`;
                    
                    if (data.dates_list.length > 0) {
                        html += '<div class="grid">';
                        data.dates_list.forEach(date => {
                            const closuresForDate = data.available_dates[date];
                            html += `<div class="card">
                                <h4>${date}</h4>
                                <p><strong>Cierres:</strong> ${closuresForDate.length}</p>
                                <ul>`;
                            closuresForDate.forEach(closure => {
                                html += `<li>${closure.register_name}</li>`;
                            });
                            html += `</ul>
                                <button class="button small" onclick="loadDate('${date}')">
                                    üìã Ver Cierres
                                </button>
                            </div>`;
                        });
                        html += '</div>';
                    } else {
                        html += '<div class="status warning">‚ö†Ô∏è No se encontraron fechas con cierres</div>';
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testSpecificRegister(registerId) {
            try {
                const response = await fetch(`/api/test-register/${registerId}`);
                const data = await response.json();
                
                let message = `üîç Test de Registro ${registerId}:\n\n`;
                
                if (data.tests.register_info?.success) {
                    message += `‚úÖ Info b√°sica: OK\n`;
                }
                
                if (data.tests.payments_summary?.success) {
                    message += `‚úÖ Payments Summary: OK\n`;
                    message += `üí∞ Total: ${data.tests.payments_summary.total_payments}\n`;
                    message += `üìù Secuencia: ${data.tests.payments_summary.sequence_number}\n`;
                } else {
                    message += `‚ùå Payments Summary: ${data.tests.payments_summary?.error}\n`;
                }
                
                alert(message);
            } catch (error) {
                alert(`Error probando registro: ${error.message}`);
            }
        }
        
        function loadDate(date) {
            document.getElementById('dateInput').value = date;
            showTab('closures');
            searchClosures();
        }
        
        function openClosure(url) {
            window.open(url, '_blank');
        }
        
        function openAllClosures() {
            if (currentClosures.length === 0) {
                alert('‚ùå No hay cierres para abrir. Primero busca cierres.');
                return;
            }
            
            const confirmed = confirm(`¬øEst√°s seguro de que quieres abrir ${currentClosures.length} cierres en nuevas pesta√±as?`);
            if (!confirmed) return;
            
            currentClosures.forEach((closure, index) => {
                setTimeout(() => {
                    window.open(closure.url, '_blank');
                }, index * 500); // 500ms de delay entre cada ventana
            });
            
            alert(`‚úÖ Abriendo ${currentClosures.length} cierres...`);
        }
    </script>
</body>
</html>
