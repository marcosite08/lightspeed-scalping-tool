<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightspeed X-Series Debug Tool - Construmas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .api-version {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .debug-badge {
            background: #e74c3c;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab.debug {
            background: #e74c3c;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .button {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .button.small {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .button.danger {
            background: #e74c3c;
        }
        
        .button.danger:hover {
            background: #c0392b;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.debug {
            background: #e74c3c;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .date-input, .select-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin: 10px;
            font-size: 16px;
        }
        
        .closure-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .closure-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .debug-card {
            border-left: 4px solid #e74c3c;
            background: #fff5f5;
        }
        
        .success-card {
            border-left: 4px solid #28a745;
            background: #f8fff8;
        }
        
        .warning-card {
            border-left: 4px solid #ffc107;
            background: #fffdf5;
        }
        
        .closure-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .closure-outlet {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .closure-id {
            font-family: monospace;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .closure-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            color: #495057;
        }
        
        .detail-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .detail-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .summary {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .api-info {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        .debug-info {
            background: #ffeaa7;
            border: 1px solid #fdcb6e;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        .json-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .recommendation {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .problem-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .problem-success {
            background: #d4edda;
            color: #155724;
        }
        
        .problem-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .problem-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .closure-details {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Lightspeed X-Series Debug Tool</h1>
            <p>Herramienta de debugging para Construmas</p>
            <div class="api-version">X-Series API v2.0 <span class="debug-badge">DEBUG MODE</span></div>
        </div>
        
        <div class="content">
            <div id="status" class="status">
                üîÑ Inicializando debugging X-Series...
            </div>
            
            <div class="tabs">
                <button class="tab debug active" onclick="showTab('debug')">üîç Debug Principal</button>
                <button class="tab" onclick="showTab('closures')">üìã Cierres</button>
                <button class="tab" onclick="showTab('registernvo')">üéØ Test RegisterNVO</button>
                <button class="tab" onclick="showTab('dates')">üìÖ Fechas</button>
                <button class="tab" onclick="showTab('connection')">üîó Conexi√≥n</button>
                <button class="tab" onclick="showTab('help')">‚ùì Ayuda</button>
            </div>
            
            <!-- Tab: Debug Principal -->
            <div id="tab-debug" class="tab-content active">
                <div class="controls">
                    <h3>üîç Debug Completo de Cierres</h3>
                    <p>Diagnostica exactamente por qu√© no se encuentran cierres</p>
                    <input type="date" id="debugDateInput" class="date-input" value="">
                    <button class="button debug" onclick="runFullDebug()">
                        üîç Ejecutar Debug Completo
                    </button>
                </div>
                
                <div class="debug-info">
                    <strong>üéØ Este debug te dir√°:</strong><br>
                    ‚Ä¢ Cu√°ntos registros tienes<br>
                    ‚Ä¢ Qu√© fechas tienen cierres<br>
                    ‚Ä¢ Por qu√© falla tu b√∫squeda<br>
                    ‚Ä¢ Qu√© endpoint no funciona<br>
                    ‚Ä¢ Recomendaci√≥n espec√≠fica
                </div>
                
                <div id="debug-results"></div>
            </div>
            
            <!-- Tab: Cierres -->
            <div id="tab-closures" class="tab-content">
                <div class="controls">
                    <h3>üìã B√∫squeda de Cierres</h3>
                    <input type="date" id="dateInput" class="date-input" value="">
                    <button class="button" onclick="searchClosures()">
                        üìã Buscar Cierres
                    </button>
                    <button class="button danger" onclick="openAllClosures()">
                        üîì Abrir Todos los Cierres
                    </button>
                </div>
                
                <div id="closures-results"></div>
            </div>
            
            <!-- Tab: Test RegisterNVO -->
            <div id="tab-registernvo" class="tab-content">
                <div class="controls">
                    <h3>üéØ Test RegisterNVO Espec√≠fico</h3>
                    <p>Prueba el registro que sabemos que cerr√≥ el 2025-07-17</p>
                    <button class="button" onclick="testRegisterNVO()">
                        üéØ Probar RegisterNVO
                    </button>
                </div>
                
                <div class="api-info">
                    <strong>RegisterNVO ID:</strong> 02dcd191-aefb-11e7-edd8-2a8a3939ec0c<br>
                    <strong>Fecha conocida:</strong> 2025-07-17<br>
                    <strong>Estado:</strong> Cerrado
                </div>
                
                <div id="registernvo-results"></div>
            </div>
            
            <!-- Tab: Fechas -->
            <div id="tab-dates" class="tab-content">
                <div class="controls">
                    <h3>üìÖ Fechas Disponibles</h3>
                    <p>Ve todas las fechas con cierres disponibles en tu sistema</p>
                    <button class="button" onclick="getAvailableDates()">
                        üìÖ Ver Fechas Disponibles
                    </button>
                </div>
                <div id="dates-results"></div>
            </div>
            
            <!-- Tab: Conexi√≥n -->
            <div id="tab-connection" class="tab-content">
                <div class="controls">
                    <h3>üîó Test de Conexi√≥n X-Series</h3>
                    <button class="button" onclick="testConnection()">
                        üîç Probar Conexi√≥n
                    </button>
                </div>
                <div id="connection-results"></div>
            </div>
            
            <!-- Tab: Ayuda -->
            <div id="tab-help" class="tab-content">
                <div class="card">
                    <h3>üÜò Problemas Comunes y Soluciones</h3>
                    
                    <h4>‚ùå "No se encontraron cierres"</h4>
                    <ul>
                        <li>Usa el <strong>Debug Principal</strong> para identificar el problema exacto</li>
                        <li>Verifica que uses una fecha que realmente tenga cierres</li>
                        <li>Prueba la pesta√±a <strong>"Fechas"</strong> para ver fechas disponibles</li>
                    </ul>
                    
                    <h4>üéØ RegisterNVO no funciona</h4>
                    <ul>
                        <li>Usa la pesta√±a <strong>"Test RegisterNVO"</strong></li>
                        <li>Verifica permisos del endpoint payments_summary</li>
                        <li>Revisa el token de API</li>
                    </ul>
                    
                    <h4>üîó Error de conexi√≥n</h4>
                    <ul>
                        <li>Verifica variables de entorno en Railway</li>
                        <li>Confirma que el token sea v√°lido</li>
                        <li>Usa la pesta√±a <strong>"Conexi√≥n"</strong> para diagnosticar</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h3>üìö URLs de Debug</h3>
                    <p><strong>Debug completo:</strong> /api/debug-closures?date=YYYY-MM-DD</p>
                    <p><strong>Test RegisterNVO:</strong> /api/test-registernvo</p>
                    <p><strong>Fechas disponibles:</strong> /api/available-dates</p>
                    <p><strong>Documentaci√≥n:</strong> <a href="https://x-series-api.lightspeedhq.com/" target="_blank">X-Series API</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentClosures = [];
        
        // Establecer fecha de hoy por defecto
        window.addEventListener('load', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            document.getElementById('debugDateInput').value = '2025-07-17'; // Fecha conocida
            testConnection();
        });
        
        function showTab(tabName) {
            // Ocultar todas las tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab seleccionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        async function runFullDebug() {
            const date = document.getElementById('debugDateInput').value;
            const resultsDiv = document.getElementById('debug-results');
            
            if (!date) {
                alert('Por favor selecciona una fecha para debug');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">üîç Ejecutando debug completo...</div>';
            
            try {
                const response = await fetch(`/api/debug-closures?date=${date}`);
                const data = await response.json();
                
                displayDebugResults(data, resultsDiv);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error en debug: ${error.message}</div>`;
            }
        }
        
        function displayDebugResults(data, container) {
            let html = '';
            
            // Problema identificado
            const problemClass = data.problem_identified === 'SUCCESS' ? 'problem-success' : 
                                data.problem_identified === 'NO_MATCHING_DATE' ? 'problem-warning' : 'problem-error';
            
            html += `<div class="card debug-card">
                <h3>üîç Resultado del Debug</h3>
                <p><strong>Problema identificado:</strong> 
                <span class="problem-indicator ${problemClass}">${data.problem_identified}</span></p>
                <div class="recommendation">
                    <strong>üí° Recomendaci√≥n:</strong><br>
                    ${data.recommendation}
                </div>
            </div>`;
            
            // Resumen
            html += `<div class="card success-card">
                <h3>üìä Resumen del Sistema</h3>
                <div class="grid">
                    <div>
                        <p><strong>Total registros:</strong> ${data.summary.total_registers}</p>
                        <p><strong>Registros con cierres:</strong> ${data.summary.registers_with_closures}</p>
                    </div>
                    <div>
                        <p><strong>Coinciden con fecha:</strong> ${data.summary.matching_registers}</p>
                        <p><strong>Payments exitosos:</strong> ${data.summary.successful_payments}</p>
                    </div>
                </div>
            </div>`;
            
            // Fechas disponibles
            if (data.available_dates.length > 0) {
                html += `<div class="card">
                    <h3>üìÖ Fechas con Cierres Disponibles</h3>
                    <p><strong>Total fechas:</strong> ${data.available_dates.length}</p>
                    <div style="margin: 10px 0;">`;
                
                data.available_dates.slice(0, 10).forEach(date => {
                    html += `<button class="button small" onclick="loadDateInDebug('${date}')" style="margin: 2px;">${date}</button>`;
                });
                
                if (data.available_dates.length > 10) {
                    html += `<p><em>... y ${data.available_dates.length - 10} fechas m√°s</em></p>`;
                }
                
                html += `</div></div>`;
            }
            
            // Cierres exitosos si los hay
            if (data.successful_closures && data.successful_closures.length > 0) {
                html += `<div class="card success-card">
                    <h3>‚úÖ Cierres Encontrados</h3>`;
                
                data.successful_closures.forEach(closure => {
                    html += `<div class="closure-card">
                        <h4>${closure.name}</h4>
                        <p><strong>Fecha:</strong> ${closure.close_date}</p>
                        <p><strong>Total:</strong> $${closure.total_payments}</p>
                        <p><strong>Secuencia:</strong> ${closure.sequence_number}</p>
                        <button class="button small" onclick="loadDateAndSearch('${closure.close_date}')">
                            üìã Buscar Esta Fecha
                        </button>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            // Detalles t√©cnicos
            html += `<div class="card">
                <h3>üîß Detalles T√©cnicos</h3>
                <button class="button small" onclick="toggleTechnicalDetails()" id="toggle-tech">
                    üëÅÔ∏è Mostrar Detalles
                </button>
                <div id="technical-details" style="display: none;">
                    <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }
        
        async function testRegisterNVO() {
            const resultsDiv = document.getElementById('registernvo-results');
            resultsDiv.innerHTML = '<div class="loading">üéØ Probando RegisterNVO...</div>';
            
            try {
                const response = await fetch('/api/test-registernvo');
                const data = await response.json();
                
                let html = `<div class="card ${data.working ? 'success-card' : 'warning-card'}">
                    <h3>${data.working ? '‚úÖ' : '‚ùå'} Test RegisterNVO</h3>
                    <p><strong>Estado:</strong> ${data.message}</p>
                    <p><strong>Fecha esperada:</strong> ${data.expected_date || 'N/A'}</p>
                    <p><strong>Pr√≥ximo paso:</strong> ${data.next_step}</p>
                </div>`;
                
                // Mostrar tests individuales
                html += `<div class="grid">`;
                
                for (const [testName, result] of Object.entries(data.tests)) {
                    const cardClass = result.success ? 'success-card' : 'warning-card';
                    html += `<div class="card ${cardClass}">
                        <h4>${testName}</h4>
                        <p><strong>Estado:</strong> ${result.success ? '‚úÖ OK' : '‚ùå Error'}</p>`;
                    
                    if (result.success && result.total_payments !== undefined) {
                        html += `<p><strong>Total:</strong> $${result.total_payments}</p>`;
                    }
                    
                    if (result.error) {
                        html += `<p><strong>Error:</strong> ${result.error}</p>`;
                    }
                    
                    html += `</div>`;
                }
                
                html += `</div>`;
                
                // Si funciona, mostrar cierre completo
                if (data.tests.complete_closure) {
                    html += `<div class="card success-card">
                        <h3>üéØ Cierre Completo Construido</h3>
                        <div class="closure-details">
                            <div class="detail-item">
                                <div class="detail-label">Outlet</div>
                                <div class="detail-value">${data.tests.complete_closure.outlet}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Fecha</div>
                                <div class="detail-value">${data.tests.complete_closure.date}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total</div>
                                <div class="detail-value">$${data.tests.complete_closure.payments}</div>
                            </div>
                        </div>
                        <button class="button" onclick="window.open('${data.tests.complete_closure.url}', '_blank')">
                            üîó Abrir Cierre
                        </button>
                        <button class="button small secondary" onclick="loadDateAndSearch('${data.tests.complete_closure.date}')">
                            üìã Buscar Esta Fecha
                        </button>
                    </div>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function searchClosures() {
            const date = document.getElementById('dateInput').value;
            const resultsDiv = document.getElementById('closures-results');
            
            if (!date) {
                alert('Por favor selecciona una fecha');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">üîç Buscando cierres...</div>';
            
            try {
                const response = await fetch(`/api/closures?date=${date}`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    currentClosures = data.data;
                    displayClosures(currentClosures, data);
                } else {
                    let html = `<div class="status warning">‚ö†Ô∏è ${data.message || 'No se encontraron cierres'}</div>`;
                    
                    if (data.suggestion) {
                        html += `<div class="recommendation">üí° ${data.suggestion}</div>`;
                    }
                    
                    if (data.debug_endpoints) {
                        html += `<div class="debug-info">
                            <strong>üîç Para diagnosticar:</strong><br>
                            <button class="button small debug" onclick="loadDateInDebug('${date}')">
                                üîç Debug Esta Fecha
                            </button>
                        </div>`;
                    }
                    
                    resultsDiv.innerHTML = html;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function displayClosures(closures, apiData) {
            const resultsDiv = document.getElementById('closures-results');
            
            const totalSales = closures.reduce((sum, c) => sum + (c.sales || 0), 0);
            const totalPayments = closures.reduce((sum, c) => sum + (c.payments || 0), 0);
            
            let html = `<div class="summary">
                <h3>üìä Resumen para ${apiData.date}</h3>
                <div class="grid">
                    <div>
                        <p><strong>Total cierres:</strong> ${closures.length}</p>
                        <p><strong>Total ventas:</strong> $${totalSales.toFixed(2)}</p>
                    </div>
                    <div>
                        <p><strong>Total pagos:</strong> $${totalPayments.toFixed(2)}</p>
                        <p><strong>API:</strong> ${apiData.api_version}</p>
                    </div>
                </div>
            </div>`;
            
            closures.forEach(closure => {
                html += `<div class="closure-card success-card">
                    <div class="closure-header">
                        <div class="closure-outlet">${closure.outlet}</div>
                        <div class="closure-id">${closure.id.split('-').pop()}</div>
                    </div>
                    
                    <div class="closure-details">
                        <div class="detail-item">
                            <div class="detail-label">Registro</div>
                            <div class="detail-value">${closure.register_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total</div>
                            <div class="detail-value">${(closure.payments || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Secuencia</div>
                            <div class="detail-value">${closure.sequence_number}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cerrado</div>
                            <div class="detail-value">${closure.closed_at ? new Date(closure.closed_at).toLocaleString() : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="button" onclick="openClosure('${closure.url}')">
                            üîó Abrir Cierre
                        </button>
                    </div>
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        async function testConnection() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('connection-results');
            
            statusDiv.textContent = 'üîÑ Probando conexi√≥n X-Series...';
            statusDiv.className = 'status';
            
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="loading">üîÑ Probando conexi√≥n...</div>';
            }
            
            try {
                const response = await fetch('/api/test');
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.textContent = '‚úÖ Conexi√≥n exitosa con X-Series API';
                    statusDiv.className = 'status success';
                    
                    if (resultsDiv) {
                        let html = '<div class="card success-card"><h3>‚úÖ Conexi√≥n X-Series</h3>';
                        html += `<p><strong>API:</strong> ${data.api_version}</p>`;
                        html += `<p><strong>URL:</strong> ${data.api_url}</p>`;
                        html += '<h4>Tests de Endpoints:</h4>';
                        
                        for (const [endpoint, result] of Object.entries(data.test_results)) {
                            const statusClass = result.success ? 'success' : 'error';
                            html += `<div class="api-info">
                                <strong>${endpoint}</strong>: ${result.success ? '‚úÖ OK' : '‚ùå Error'}
                                ${result.count ? ` (${result.count} items)` : ''}
                            </div>`;
                        }
                        
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    }
                } else {
                    throw new Error(data.error || 'Error de conexi√≥n');
                }
            } catch (error) {
                statusDiv.textContent = '‚ùå Error de conexi√≥n X-Series';
                statusDiv.className = 'status error';
                
                if (resultsDiv) {
                    resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                }
            }
        }
        
        async function getAvailableDates() {
            const resultsDiv = document.getElementById('dates-results');
            resultsDiv.innerHTML = '<div class="loading">üìÖ Obteniendo fechas...</div>';
            
            try {
                const response = await fetch('/api/available-dates');
                const data = await response.json();
                
                if (data.success) {
                    let html = `<div class="card">
                        <h3>üìÖ Fechas Disponibles</h3>
                        <p><strong>Total registros:</strong> ${data.total_registers}</p>
                        <p><strong>Registros con cierres:</strong> ${data.registers_with_closures}</p>
                        <p><strong>Fechas diferentes:</strong> ${data.dates_list.length}</p>
                    </div>`;
                    
                    if (data.dates_list.length > 0) {
                        html += '<div class="card success-card"><h3>üóìÔ∏è Fechas con Cierres</h3>';
                        
                        data.most_recent_dates.forEach(date => {
                            const closuresCount = data.available_dates[date].length;
                            html += `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <strong>${date}</strong> (${closuresCount} cierres)
                                <br>
                                <button class="button small" onclick="loadDateAndSearch('${date}')">
                                    üìã Buscar Cierres
                                </button>
                                <button class="button small debug" onclick="loadDateInDebug('${date}')">
                                    üîç Debug
                                </button>
                            </div>`;
                        });
                        
                        html += '</div>';
                    } else {
                        html += '<div class="status warning">‚ö†Ô∏è No se encontraron fechas con cierres</div>';
                    }
                    
                    if (data.suggestion) {
                        html += `<div class="recommendation">üí° ${data.suggestion}</div>`;
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function loadDateInDebug(date) {
            document.getElementById('debugDateInput').value = date;
            showTab('debug');
            runFullDebug();
        }
        
        function loadDateAndSearch(date) {
            document.getElementById('dateInput').value = date;
            showTab('closures');
            searchClosures();
        }
        
        function openClosure(url) {
            window.open(url, '_blank');
        }
        
        function openAllClosures() {
            if (currentClosures.length === 0) {
                alert('‚ùå No hay cierres para abrir. Primero busca cierres.');
                return;
            }
            
            const confirmed = confirm(`¬øEst√°s seguro de que quieres abrir ${currentClosures.length} cierres?`);
            if (!confirmed) return;
            
            currentClosures.forEach((closure, index) => {
                setTimeout(() => {
                    window.open(closure.url, '_blank');
                }, index * 500);
            });
            
            alert(`‚úÖ Abriendo ${currentClosures.length} cierres...`);
        }
        
        function toggleTechnicalDetails() {
            const details = document.getElementById('technical-details');
            const button = document.getElementById('toggle-tech');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                button.textContent = 'üëÅÔ∏è Ocultar Detalles';
            } else {
                details.style.display = 'none';
                button.textContent = 'üëÅÔ∏è Mostrar Detalles';
            }
        }
    </script>
</body>
</html>
